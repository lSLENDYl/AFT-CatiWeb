{% extends "base.html" %}

{% block title %}Редактор текста{% endblock %}

{% block content %}
    <div class="content">
        <h1>Редактор текста</h1>
        <p>Это страница с редактором текста. Здесь вы можете редактировать и форматировать ваш текст.</p>

        <form method="POST" id="mainForm">
            <div class="form-group">
                {% if simplified_text %}
                    <div class="text-output"
                         id="editableArea"
                         contenteditable="true"
                         data-placeholder="Введите текст здесь...">{{ simplified_text|safe }}</div>
                {% else %}
                    <div class="text-input"
                         id="editableArea"
                         contenteditable="true"
                         data-placeholder="Введите текст здесь...">{{ input_text|safe }}</div>
                {% endif %}
                <input type="hidden" id="hiddenInput" name="input_text">
            </div>

            <h2 class="animate" id="loading">Загрузка...</h2>
        </form>
    </div>

    <div id="simplify-menu" class="context-menu">
        <div class="menu-title">Упростить на:</div>
        <div class="menu-item" id="simplify-option"></div>
    </div>

    <script>
        let currentSelectedWord = null;

        // Обновление скрытого поля перед отправкой формы
        document.getElementById('mainForm').addEventListener('submit', function(e) {
            const editableDiv = document.getElementById('editableArea');
            document.getElementById('hiddenInput').value = editableDiv.innerHTML;
        });

        // Обработчик клика по тексту
        document.getElementById('editableArea').addEventListener('click', function(e) {
            const target = e.target;
            if (target.classList.contains('simplify-mark')) {
                currentSelectedWord = target;
                showContextMenu(target, e.clientX, e.clientY);
                e.preventDefault();
            }
        });

        // Показ контекстного меню
        function showContextMenu(element, posX, posY) {
            const menu = document.getElementById('simplify-menu');
            const simpleVersion = element.dataset.simple;

            document.getElementById('simplify-option').textContent = simpleVersion;

            menu.style.display = 'block';
            menu.style.left = `${posX}px`;
            menu.style.top = `${posY}px`;
        }

        // Скрытие меню
        function hideContextMenu() {
            document.getElementById('simplify-menu').style.display = 'none';
            currentSelectedWord = null;
        }

        // Обработчик выбора замены
        document.getElementById('simplify-option').addEventListener('click', function() {
            if (currentSelectedWord) {
                const original = currentSelectedWord.dataset.original;
                const simple = currentSelectedWord.dataset.simple;

                // Замена содержимого
                currentSelectedWord.outerHTML =
                    `<span class="replaced-word"
                          data-original="${original}"
                          title="Упрощено из: ${original}">${simple}</span>`;

                hideContextMenu();
            }
        });

        // Скрытие меню при клике вне его
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.context-menu') &&
                !e.target.closest('.simplify-mark')) {
                hideContextMenu();
            }
        });

        // Обработчик пробела для автоматического упрощения
        let lastSentText = "";
        let isProcessing = false;

        document.getElementById('editableArea').addEventListener('keydown', function(e) {
            if (e.key === ' ' && !isProcessing) {
                isProcessing = true;
                const currentText = this.innerHTML;
                lastSentText = currentText;

                document.getElementById('loading').style.display = 'flex';

                fetch('/process-text', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text: currentText })
                })
                .then(response => response.json())
                .then(data => {
                    const currentUserText = this.innerHTML;

                    // Если текст не менялся - просто подставляем результат
                    if (currentUserText === lastSentText) {
                        this.innerHTML = data.simplified_text;
                    }
                    // Если текст изменился - находим разницу и объединяем
                    else {
                        const processedPart = data.simplified_text;
                        const newUserText = currentUserText.replace(lastSentText, '');
                        this.innerHTML = processedPart + newUserText;
                    }
                })
                .catch(error => console.error('Error:', error))
                .finally(() => {
                    isProcessing = false;
                    document.getElementById('loading').style.display = 'none';
                });
            }
        });
    </script>
{% endblock %}